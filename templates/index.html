<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Koko AI</title>

  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#fffdfd;
      --card:#12121b;
      --card2:#141421;
      --border:rgba(255,255,255,.10);
      --text:#000000;
      --muted:rgba(233,233,243,.70);
      --muted2:rgba(233,233,243,.45);
      --accent:#8b5cf6; /* purple */
      --accent2:#6366f1; /* indigo */
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 55% 20%, rgba(139,92,246,.18), transparent 60%),
        radial-gradient(900px 600px at 20% 10%, rgba(99,102,241,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:auto;
    }

    /* Layout */
    .app{
      display:flex;
      height:100vh;
      width:100vw;
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      min-width:240px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      background: rgb(170, 206, 253);
      border-right:1px solid var(--border);
      backdrop-filter: blur(10px);
      overflow:hidden;        /* ‚úÖ prevent sidebar itself from scrolling */
    }

    .sb-chatlist{
      flex:1;                 /* ‚úÖ takes remaining height */
      min-height:0;           /* ‚úÖ allows scrolling */
      overflow-y:auto;        /* ‚úÖ scroll list */
      padding-right:4px;
    }

    .sb-bottom{
      margin-top:auto;        /* ‚úÖ pins buttons to bottom */
      flex-shrink:0;          /* ‚úÖ never gets squeezed */
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }

    .sb-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 6px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand img{
      width: 70px; height: 70px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid var(--border);
    }
    .brand .name{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .brand .name b{font-size:14px}
    .brand .name span{font-size:12px; color:black}

    .sb-btn{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0, 0, 0, 0.04);
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.18s ease;
    }
    .sb-btn:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }

    .sb-section-title{
      margin-top:8px;
      font-size:12px;
      color:black;
      padding:4px 6px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .sb-chatlist{
      flex:1;
      overflow:auto;
      padding-right:4px;
    }
    .chat-item{
      padding:10px 12px;
      border-radius:12px;
      color:black;
      cursor:pointer;
      border:1px solid transparent;
      transition:.15s ease;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chat-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color:var(--text);
    }

    .sb-bottom{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }

    .pill{
      border:none;
      border-radius:14px;
      padding:11px 12px;
      cursor:pointer;
      color:var(--text);
      background: linear-gradient(90deg, rgb(249, 250, 250), rgb(249, 250, 250));
      box-shadow: 0 10px 25px rgba(99,102,241,.18);
      transition:.15s ease;
    }
    .pill:hover{transform: translateY(-1px); filter:saturate(1.1)}
    .ghost{
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      box-shadow:none;
    }

    /* Main area */
  .main{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:stretch;
    justify-content:flex-start;
    padding:26px 22px 18px;
    gap:18px;
    overflow:hidden;  /* ‚úÖ stop whole page scrolling */
    min-height:0;     /* ‚úÖ needed for inner scrolling */
  }

    .hero{
      width: 100%;
      max-width: 900px;   /* match your chat-shell max-width */
      margin: 10px auto 0; /* ‚úÖ centers the whole hero block */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .hero h1{
      width: 100%;
      text-align: center;
    }

    .hero-sub{
      color:var(--muted);
      font-size:13px;
      text-align:center;
      margin-top:-6px;
    }

    .columns{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:6px;
    }

    .col{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .col-title{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
      margin:8px 0 2px;
    }
    .icon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      background: rgba(255,255,255,.04);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: var(--shadow);
      min-height:64px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--text);
    }
    .card small{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .slider-labels{
      width:100%;
      display:flex;
      justify-content:space-between;
      color:var(--muted2);
      font-size:12px;
      padding:0 4px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    /* Chat area */
    .chat-shell{
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    flex: 1;
    min-height: 0;
    display:flex;
    flex-direction:column;
  }

  .koko-float{
    position: fixed;
    bottom: 16px;
    left: calc(280px + 16px);
    z-index: 50;           /* below UI, above background */
    pointer-events: none; /* don't block clicks */
  }

  .koko-float img{
    width: 200px;           /* üî¥ THIS was missing */
    height: 250px;
    border-radius: 18px;
    opacity: .95;
  }

  .sidebar{
    display:flex;
    flex-direction:column;
    height:100vh;          /* important */
  }

.promptbar{
  width: 100%;
  margin-top: 12px;
  display:flex;
  align-items:center;
  gap:10px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgb(252, 251, 251);
  border-radius: 18px;
  padding: 10px 12px;
  box-shadow: 0 18px 45px rgba(0,0,0,.25);
}

textarea{
  flex:1;
  min-width:0;
  height:44px;
  border:none;
  outline:none;
  resize:none;
  background:transparent;
  color: black;
  font-size:14px;
  padding:10px 6px;
}

.send{
  width:42px;
  height:42px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  color:rgb(15, 15, 15);
  background: linear-gradient(90deg, #3dc2ff, #3dc2ff);
  display:grid;
  place-items:center;
}



  .sb-bottom{
    margin-top:auto;       /* THIS pushes it to the bottom */
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-top:10px;
    border-top:1px solid var(--border);
  }


 #messages{
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: rgb(255, 253, 253);
  backdrop-filter: blur(8px);
  padding: 14px;
  box-shadow: var(--shadow);

  display:flex;
  flex-direction:column;
  gap:12px;
}

/* each row */
.msg{
  display:flex;
  gap:12px;
  align-items:flex-start;
}

/* koko left, you right */
.msg.user{ justify-content:flex-end; }
.msg.koko{ justify-content:flex-start; }

/* avatar */
.avatar{
  width:44px;
  height:44px;
  border-radius:15px;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.14);
  flex: 0 0 auto;
  margin-top:2px;
}

/* the card bubble */
.bubble{
  max-width: 780px;
  width: fit-content;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgb(253, 245, 245);
  background: rgb(253, 245, 245);  /* dark card */
  backdrop-filter: blur(8px);
  color: rgba(0, 0, 0, 0.92);
  box-shadow: 0 10px 28px rgba(0,0,0,.35);
}

/* user bubble slightly different */
.msg.user .bubble{
  background:rgb(253, 245, 245);
}

/* header line inside bubble */
.meta{
  display:flex;
  gap:10px;
  align-items:center;
  font-size:12px;
  color: rgba(233,233,243,.55);
  margin-bottom:6px;
}
.meta .name{
  color: #12121b;          /* dark readable */
  font-weight:600;
}

.meta .time{ opacity:.9; }

/* message text */
.text{
  font-size:14px;
  line-height:1.45;
  white-space:pre-wrap;
}

/* remove old colors (your msg-you/msg-bot) */
.msg-you, .msg-bot{ color: inherit; }

  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <img src="{{ url_for('static', filename='KOKO.PNG') }}" alt="Koko"/>
          <div class="name">
            <b>Koko AI üê®</b>
            <span>Your AI friend for HCP</span>
          </div>
        </div>
      </div>

      <button class="sb-btn" onclick="newChat()">
        <span>+ New Chat</span>
        <span style="color:var(--muted2)">Ctrl+K</span>
      </button>

      <div class="sb-section-title">Chats</div>

      <div class="sb-chatlist" id="chatList"></div>

      <div class="sb-bottom">
        <button class="pill ghost" onclick="clearMessages()">Clear</button>
        <button class="pill" onclick="alert('Hook this to your login/logout later')">Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="hero">
        <h1 style="text-align:center;">Koko üê®</h1>
      </section>

      <!-- Chat -->
      <section class="chat-shell" id="promptArea">
        <div id="messages"></div>

        <div class="promptbar">
          <textarea id="input" placeholder="Message Koko... (Enter to send, Shift+Enter for new line)"></textarea>
          <button class="send" id="sendBtn" type="button">‚û§</button>




        </div>
      </section>
    </main>

        <div class="koko-float">
    <img src="{{ url_for('static', filename='Koala_Thinking.png') }}" alt="Koko">
  </div>

  </div>

  <script>
  let chats = [];
  let activeChatId = null;
  let isSending = false;

    function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }


  function createChat(title = "New chat") {
    const id = Date.now().toString();
    chats.unshift({ id, title, messages: [] });
    activeChatId = id;
    renderChatList();
    renderActiveChat();
  }

  function renderChatList() {
    const list = document.getElementById("chatList");
    if (!list) return;

    list.innerHTML = chats.map(c => `
      <div class="chat-item ${c.id === activeChatId ? "active" : ""}"
           onclick="selectChat('${c.id}')">
        ${escapeHtml(c.title)}
      </div>
    `).join("");
  }

  function selectChat(id) {
    activeChatId = id;
    renderChatList();
    renderActiveChat();
  }

  function renderActiveChat() {
    const messagesEl = document.getElementById("messages");
    const chat = chats.find(c => c.id === activeChatId);
    messagesEl.innerHTML = "";
    if (!chat) return;

    for (const m of chat.messages) {
      appendLine(m.who, m.text);
    }
  }

  function newChat() {
    createChat("Chat " + (chats.length + 1));
    document.getElementById("input").focus();
  }

  function clearMessages() {
    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) return;
    chat.messages = [];
    renderActiveChat();
  }

  function scrollToPrompt() {
    document.getElementById("promptArea").scrollIntoView({ behavior: "smooth", block: "end" });
    document.getElementById("input").focus();
  }

function appendLine(who, text) {
  const messages = document.getElementById("messages");

  const row = document.createElement("div");
  row.className = (who === "You") ? "msg user" : "msg koko";

  // Avatar only for Koko (you can also add yours if you want)
  if (who !== "You") {
    const av = document.createElement("img");
    av.className = "avatar";
    av.src = "{{ url_for('static', filename='KOKO.PNG') }}"; // or another koko icon
    av.alt = "Koko";
    row.appendChild(av);
  }

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span class="name">${who}</span><span class="time">Just now</span>`;

  const body = document.createElement("div");
  body.className = "text";
  body.textContent = text;

  bubble.appendChild(meta);
  bubble.appendChild(body);
  row.appendChild(bubble);

  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;
}

async function sendMessage() {
  if (isSending) return;

  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const messagesEl = document.getElementById("messages");

  const userText = input.value.trim();
  if (!userText) return;

  // ‚úÖ get chat FIRST
  let chat = chats.find(c => c.id === activeChatId);
  if (!chat) {



    createChat("New chat");
    chat = chats.find(c => c.id === activeChatId);
  }

  isSending = true;
  sendBtn.disabled = true;
  input.value = "";

  // ‚úÖ show + save user msg
  chat.messages.push({ who: "You", text: userText });
  appendLine("You", userText);

  // ‚úÖ rename chat title from first message
  if (chat.title === "New chat" || chat.title.startsWith("Chat ")) {
    chat.title = userText.slice(0, 24);
    renderChatList();
  }

  // ‚úÖ Koko streaming card
  const row = document.createElement("div");
  row.className = "msg koko";

  const av = document.createElement("img");
  av.className = "avatar";
  av.src = "{{ url_for('static', filename='Koala Talking.PNG') }}";
  av.alt = "Koko";
  row.appendChild(av);

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = `
    <div class="meta">
      <span class="name">Koko</span>
      <span class="time">Just now</span>
    </div>
    <div class="text"><span class="stream"></span></div>
  `;
  row.appendChild(bubble);
  messagesEl.appendChild(row);

  const span = bubble.querySelector(".stream");
  let kokoFull = "";

  try {
    const response = await fetch("/chat_stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userText })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split("\n\n");
      buffer = parts.pop();

      for (const part of parts) {
        if (!part.startsWith("data: ")) continue;
        const payload = JSON.parse(part.slice(6));

        if (payload.delta) {
          kokoFull += payload.delta;
          span.textContent += payload.delta;
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      }
    }

    chat.messages.push({ who: "Koko", text: kokoFull || "(no response)" });

  } catch (err) {
    console.error(err);
    span.textContent = "Error: stream failed.";
    chat.messages.push({ who: "Koko", text: "Error: stream failed." });

  } finally {
    isSending = false;
    sendBtn.disabled = false;
    input.focus();
  }
}


  // Enter to send (Shift+Enter newline)
const inputEl = document.getElementById("input");

if (!window.__kokoKeyListenerAdded) {
  window.__kokoKeyListenerAdded = true;

  inputEl.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById("sendBtn").addEventListener("click", sendMessage);
}

  // ‚úÖ THIS MUST BE OUTSIDE ANY OTHER LISTENER
  window.addEventListener("load", () => {
    if (!activeChatId) createChat("New chat");
  });
</script>
</body>
</html>