<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Koko AI</title>

  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#fffdfd;
      --card:#12121b;
      --card2:#141421;
      --border:rgba(255,255,255,.10);
      --text:#000000;
      --muted:rgba(233,233,243,.70);
      --muted2:rgba(233,233,243,.45);
      --accent:#8b5cf6; /* purple */
      --accent2:#6366f1; /* indigo */
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: #fffdfd;
      overflow: auto;
    }

    /* Layout */
    .app{
      display:flex;
      height:100vh;
      width:100vw;
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      min-width:240px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      background: linear-gradient(180deg, #eff6ff 0%, #dbeafe 100%);
      border-right:1px solid rgba(191,219,254,.9);
      backdrop-filter: blur(10px);
      overflow:hidden;        /* ‚úÖ prevent sidebar itself from scrolling */
    }

    .sb-chatlist{
      flex:1;                 /* ‚úÖ takes remaining height */
      min-height:0;           /* ‚úÖ allows scrolling */
      overflow-y:auto;        /* ‚úÖ scroll list */
      padding-right:4px;
    }

    .sb-bottom{
      margin-top:auto;        /* ‚úÖ pins buttons to bottom */
      flex-shrink:0;          /* ‚úÖ never gets squeezed */
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:10px;
      border-top:1px solid rgba(191,219,254,.7);
    }

    .sb-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 6px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand img{
      width: 70px; height: 70px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid rgba(191,219,254,.8);
      background: rgba(255,255,255,.9);
    }
    .brand .name{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .brand .name b{font-size:14px}
    .brand .name span{font-size:12px; color:#475569}
    .brand-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:6px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      color:#0f172a;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(15,23,42,.12);
      width:fit-content;
    }
    .brand-status .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.7);
      animation:pulse 2.4s ease-in-out infinite;
    }
    .brand-status.thinking .dot{
      background:#f59e0b;
      box-shadow:0 0 8px rgba(245,158,11,.7);
    }
    .brand-status.listening .dot{
      background:#6366f1;
      box-shadow:0 0 8px rgba(99,102,241,.7);
    }
    .brand-status.speaking .dot{
      background:#ec4899;
      box-shadow:0 0 8px rgba(236,72,153,.7);
    }

    .sb-btn{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(191,219,254,.9);
      background: rgba(255,255,255,.9);
      color:#2563eb;
      box-shadow: 0 6px 16px rgba(37,99,235,.12);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.18s ease;
    }
    .sb-btn:hover{
      background: #eff6ff;
      border-color: rgba(147,197,253,.9);
      transform: translateY(-1px);
    }

    .sb-section-title{
      margin-top:8px;
      font-size:12px;
      color:#64748b;
      padding:4px 6px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .sb-chatlist{
      flex:1;
      overflow:auto;
      padding-right:4px;
    }

    .sb-search{
      width:100%;
      border:1px solid rgba(191,219,254,.9);
      border-radius:10px;
      padding:8px 10px;
      background: rgba(255,255,255,.85);
      color:#0f172a;
      outline:none;
      font-size:12px;
    }

    .tag-filters{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      padding:6px 4px;
    }

    .tag-filter{
      border:1px solid rgba(191,219,254,.9);
      background: rgba(255,255,255,.8);
      color:#1e3a8a;
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
    }

    .tag-filter.active{
      background: rgba(191,219,254,.8);
      border-color: rgba(147,197,253,.9);
    }

    .chat-tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .chat-tag{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.2);
    }



    .chat-item{
      padding:10px 12px;
      border-radius:12px;
      color:black;
      cursor:pointer;
      border:1px solid transparent;
      transition:.15s ease;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chat-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color:var(--text);
    }

        .typing-indicator{
      display:none;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      margin-top:12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
      color:#0f172a;
      font-size:13px;
      width:fit-content;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .2s ease, transform .2s ease;
    }
    .typing-indicator.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .typing-indicator .dots{
      display:inline-flex;
      gap:4px;
    }
    .typing-indicator .dots span{
      width:6px;
      height:6px;
      border-radius:50%;
      background:#346aff;
      animation:typing 1.2s infinite ease-in-out;
    }
    .typing-indicator .dots span:nth-child(2){ animation-delay:.2s; }
    .typing-indicator .dots span:nth-child(3){ animation-delay:.4s; }


    .sb-bottom{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }

    .pill{
      border:none;
      border-radius:14px;
      padding:11px 12px;
      cursor:pointer;
      color:#1f2937;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(191,219,254,.9);
      box-shadow: 0 8px 20px rgba(59,130,246,.12);
      transition:.15s ease;
    }
    .pill:hover{transform: translateY(-1px); filter:saturate(1.1)}
    .ghost{
      background: rgba(255,255,255,.6);
      border:1px solid rgba(191,219,254,.7);
      box-shadow:none;
    }

    /* Main area */
  .main{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:stretch;
    justify-content:flex-start;
    padding:16px 22px 18px;
    gap:18px;
    overflow:hidden;  /* ‚úÖ stop whole page scrolling */
    min-height:0;     /* ‚úÖ needed for inner scrolling */
  }

    .hero{
      width: 100%;
      max-width: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .hero h1{
      width: 100%;
      text-align: left;
      margin: 0;
    }

    .hero-sub{
      color:var(--muted);
      font-size:13px;
      text-align:center;
      margin-top:-6px;
    }

    .columns{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:6px;
    }

    .col{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .col-title{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
      margin:8px 0 2px;
    }
    .icon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      background: rgba(255,255,255,.04);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: var(--shadow);
      min-height:64px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--text);
    }
    .card small{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .slider-labels{
      width:100%;
      display:flex;
      justify-content:space-between;
      color:var(--muted2);
      font-size:12px;
      padding:0 4px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    /* Chat area */
    .chat-shell{
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    flex: 1;
    min-height: 0;
    display:flex;
    flex-direction:column;
  }

  .koko-float{
    position: fixed;
    bottom: 16px;
    right: 16px;           /* below UI, above background */
    pointer-events: none; /* don't block clicks */
  }

  .koko-float img{
    width: 84px;
    height: 84px;
    border-radius: 18px;
    opacity: .95;
        box-shadow: 0 18px 45px rgba(99,102,241,.25);
    animation: floatBreath 4s ease-in-out infinite;
  }

  @keyframes messageIn{
    from{ opacity:0; transform:translateY(8px); }
    to{ opacity:1; transform:translateY(0); }
  }
  @keyframes floatBreath{
    0%,100%{ transform:translateY(0) scale(1); }
    50%{ transform:translateY(-6px) scale(1.02); }
  }
  @keyframes pulse{
    0%,100%{ transform:scale(1); opacity:.8; }
    50%{ transform:scale(1.2); opacity:1; }
  }
  @keyframes typing{
    0%,80%,100%{ transform:translateY(0); opacity:.5; }
    40%{ transform:translateY(-4px); opacity:1; }

  }

  .sidebar{
    display:flex;
    flex-direction:column;
    height:100vh;          /* important */
  }

.promptbar{
  width: 100%;
  margin-top: 8px;
  display:flex;
  align-items:center;
  gap:10px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgb(252, 251, 251);
  border-radius: 18px;
  padding: 10px 12px;
  box-shadow: 0 18px 45px rgba(0,0,0,.25);
}

.actions-bar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

.action-btn{
  border:1px solid var(--border);
  background: rgba(0, 0, 0, 0.04);
  color:var(--text);
  border-radius:12px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}

.suggestions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}

.suggestion-btn{
  border:1px dashed rgba(0,0,0,.15);
  background: rgba(255,255,255,.6);
  color:var(--text);
  border-radius:12px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}


textarea{
  flex:1;
  min-width:0;
  height:44px;
  border:none;
  outline:none;
  resize:none;
  background:transparent;
  color: black;
  font-size:14px;
  padding:10px 6px;
}

.send{
  width:42px;
  height:42px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  color:rgb(15, 15, 15);
  background: linear-gradient(90deg, #3dc2ff, #3dc2ff);
  display:grid;
  place-items:center;
}

.attach{
  width:42px;
  height:42px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  color:rgb(15, 15, 15);
  background: rgba(0, 0, 0, 0.05);
  display:grid;
  place-items:center;
}


  .sb-bottom{
    margin-top:auto;       /* THIS pushes it to the bottom */
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-top:10px;
    border-top:1px solid var(--border);
  }


 #messages{
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  border: none;
  border-radius: 0;
  background: transparent;
  backdrop-filter: none;
  padding: 0;
  box-shadow: none;


  display:flex;
  flex-direction:column;
  gap:12px;
}

/* each row */
.msg{
  display:flex;
  gap:12px;
  align-items:flex-start;
 animation:messageIn .2s ease forwards;
}

/* koko left, you right */
.msg.user{ justify-content:flex-end; }
.msg.koko{
    justify-content: flex-end;
    align-items: flex-end;
    flex-direction: row-reverse;
    gap: 8px;
}

.msg.koko .avatar{
  width:36px;
  height:36px;
  border-radius:12px;
  align-self: flex-end;
}

/* avatar */
.avatar{
  width:50px;
  height:50px;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.14);
  flex: 0 0 auto;
  margin-top:2px;
  box-shadow:0 0 16px rgba(99,102,241,.25);

}

/* the card bubble */
.bubble{
  max-width: 780px;
  width: fit-content;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgb(253, 245, 245);
  background: rgb(253, 245, 245);  /* dark card */
  backdrop-filter: blur(8px);
  color: rgba(0, 0, 0, 0.92);
  box-shadow: 0 10px 28px rgba(0,0,0,.35);
}

.msg-actions{
  display:flex;
  gap:6px;
  margin-top:8px;
}

.msg-action{
  border:1px solid var(--border);
  background: rgba(0,0,0,.03);
  color:var(--text);
  border-radius:10px;
  padding:4px 8px;
  font-size:11px;
  cursor:pointer;
}

.num-highlight{
  background: rgba(255, 230, 150, 0.55);
  padding:0 4px;
  border-radius:6px;
  font-weight:600;
}

.meta .trend{
  margin-left:auto;
  font-size:12px;
}

.details-toggle{
  border:none;
  background: transparent;
  color: #4f46e5;
  cursor:pointer;
  font-size:12px;
  margin-top:6px;
}


/* user bubble slightly different */
.msg.user .bubble{
  background:rgb(253, 245, 245);
}

/* header line inside bubble */
.meta{
  display:flex;
  gap:10px;
  align-items:center;
  font-size:12px;
  color: rgba(233,233,243,.55);
  margin-bottom:6px;
}
.meta .name{
  color: #12121b;          /* dark readable */
  font-weight:600;
}

.meta .time{ opacity:.9; }

/* message text */
.text{
  font-size:14px;
  line-height:1.45;
  white-space:pre-wrap;
}

/* remove old colors (your msg-you/msg-bot) */
.msg-you, .msg-bot{ color: inherit; }

  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <img src="{{ url_for('static', filename='KOKO.png') }}" alt="Koko"/>
          <div class="name">
            <b>Koko AI üê®</b>
            <span>Your AI friend for HCP</span>
              <div class="brand-status listening" id="kokoStatus">
              <span class="dot"></span>
              <span class="label">Listening</span>
            </div>

          </div>
        </div>
      </div>

      <button class="sb-btn" onclick="newChat()">
        <span>+ New Chat</span>
        <span style="color:var(--muted2)">Ctrl+K</span>
      </button>

      <input class="sb-search" id="chatSearch" placeholder="Search chats..." />

      <div class="tag-filters" id="tagFilters">
        <button class="tag-filter active" data-tag="all">All</button>
      </div>


      <div class="sb-section-title">Chats</div>

      <div class="sb-chatlist" id="chatList"></div>

            <div class="sb-section-title">Pinned</div>
      <div class="sb-chatlist" id="pinnedList"></div>

      <div class="sb-section-title">Bookmarks</div>
      <div class="sb-chatlist" id="bookmarkList"></div>

      <div class="sb-bottom">
        <button class="pill ghost" onclick="clearMessages()">Clear</button>
        <button class="pill" onclick="alert('Hook this to your login/logout later')">Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="hero">
        <h1>Koko üê®</h1>
      </section>

      <!-- Chat -->
      <section class="chat-shell" id="promptArea">
        <div id="messages"></div>
          <div class="typing-indicator" id="typingIndicator" aria-live="polite">
          <span>Koko is thinking</span>
          <span class="dots" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>


        <div class="promptbar">
          <input id="docUpload" type="file" accept=".txt,.md,.csv,.pdf" hidden />
          <button class="attach" id="uploadBtn" type="button" title="Upload a document">üìé</button>
          <textarea id="input" placeholder="Message Koko... (Enter to send, Shift+Enter for new line)"></textarea>
          <button class="send" id="sendBtn" type="button">‚û§</button>




        </div>

          <div class="actions-bar" id="quickActions">
          <button class="action-btn" data-action="Summarize in 3 bullets.">Summarize</button>
          <button class="action-btn" data-action="Highlight the key numbers and what they mean.">Key numbers</button>
          <button class="action-btn" data-action="Give me the next steps.">Next steps</button>
          <button class="action-btn" data-action="List risks or blockers to watch.">Risks</button>
        </div>
        <div class="suggestions" id="suggestions"></div>


      </section>
    </main>

        <div class="koko-float">
    <img src="{{ url_for('static', filename='Koala_Thinking.png') }}" alt="Koko">
  </div>

  </div>

  <script>
  let chats = [];
  let activeChatId = null;
  let isSending = false;
  let pinnedItems = [];
  let bookmarkedItems = [];
  let activeTagFilter = "all";
  let hasShownTyping = false;

  function setKokoStatus(state, label) {
    const statusEl = document.getElementById("kokoStatus");
    if (!statusEl) return;
    statusEl.classList.remove("listening", "thinking", "speaking");
    statusEl.classList.add(state);
    const labelEl = statusEl.querySelector(".label");
    if (labelEl) labelEl.textContent = label;
  }

  function showTypingIndicator() {
    const indicator = document.getElementById("typingIndicator");
    if (!indicator) return;
    indicator.classList.add("show");
  }

  function hideTypingIndicator() {
    const indicator = document.getElementById("typingIndicator");
    if (!indicator) return;
    indicator.classList.remove("show");
  }



    function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }


  function createChat(title = "New chat") {
    const id = Date.now().toString();
    chats.unshift({ id, title, messages: [], tags: [] });
    activeChatId = id;
    renderChatList();
    renderActiveChat();
  }

  function renderChatList() {
    const list = document.getElementById("chatList");
    if (!list) return;

    const searchValue = (document.getElementById("chatSearch")?.value || "").toLowerCase();
    const filtered = chats.filter(c => {
      const matchesSearch = !searchValue || c.title.toLowerCase().includes(searchValue);
      const matchesTag = activeTagFilter === "all" || (c.tags || []).includes(activeTagFilter);
      return matchesSearch && matchesTag;
    });

    list.innerHTML = filtered.map(c => `
      <div class="chat-item ${c.id === activeChatId ? "active" : ""}"
           onclick="selectChat('${c.id}')">
        ${escapeHtml(c.title)}
      </div>
    `).join("");
  }

    function renderChatTags(tags = []) {
    if (!tags.length) return "";
    return `
      <div class="chat-tags">
        ${tags.map(tag => `<span class="chat-tag">${tag}</span>`).join("")}
      </div>
    `;
  }


  function selectChat(id) {
    activeChatId = id;
    renderChatList();
    renderActiveChat();
  }

  function renderActiveChat() {
    const messagesEl = document.getElementById("messages");
    const chat = chats.find(c => c.id === activeChatId);
    messagesEl.innerHTML = "";
    if (!chat) return;

    for (const m of chat.messages) {
      appendLine(m.who, m.text);
    }
  }

  function newChat() {
    createChat("Chat " + (chats.length + 1));
    document.getElementById("input").focus();
  }

  function clearMessages() {
    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) return;
    chat.messages = [];
    renderActiveChat();
  }

  function scrollToPrompt() {
    document.getElementById("promptArea").scrollIntoView({ behavior: "smooth", block: "end" });
    document.getElementById("input").focus();
  }

function appendLine(who, text) {
  const messages = document.getElementById("messages");
  const messageId = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;


  const row = document.createElement("div");
  row.className = (who === "You") ? "msg user" : "msg koko";
  row.dataset.messageId = messageId;

  // Avatar only for Koko (you can also add yours if you want)
  if (who !== "You") {
    const av = document.createElement("img");
    av.className = "avatar";
    av.src = "{{ url_for('static', filename='KOKO.png') }}"; // or another koko icon
    av.alt = "Koko";
    row.appendChild(av);
  }

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span class="name">${who}</span><span class="time">Just now</span>`;

  const body = document.createElement("div");
  body.className = "text";
    if (who === "You") {
    body.textContent = text;
  } else {
    body.innerHTML = formatAssistantText(text);
  }

  bubble.appendChild(meta);
  bubble.appendChild(body);

    if (who !== "You") {
    const trendEmoji = getTrendEmoji(text);
    if (trendEmoji) {
      const trend = document.createElement("span");
      trend.className = "trend";
      trend.textContent = trendEmoji;
      meta.appendChild(trend);
    }

    const toggle = document.createElement("button");
    toggle.className = "details-toggle";
    toggle.dataset.fullText = text;
    toggle.dataset.collapsed = "true";
    toggle.addEventListener("click", () => {
      const collapsed = toggle.dataset.collapsed === "true";
      setDetailsState(toggle, body, !collapsed);
    });
    bubble.appendChild(toggle);
    setDetailsState(toggle, body, true);

    const actions = document.createElement("div");
    actions.className = "msg-actions";
    actions.innerHTML = `
      <button class="msg-action" data-action="pin">üìå Pin</button>
      <button class="msg-action" data-action="bookmark">‚≠ê Bookmark</button>
      <button class="msg-action" data-action="copy">Copy</button>
    `;
    actions.addEventListener("click", (e) => handleMessageAction(e, messageId, text));
    bubble.appendChild(actions);
  }

  row.appendChild(bubble);

  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;
}
function formatAssistantText(text) {
  const safe = escapeHtml(text);
  return safe.replace(/(\b\d[\d,\.%]*\b)/g, '<span class="num-highlight">$1</span>');
}

function setDetailsState(button, body, collapsed) {
  const fullText = button.dataset.fullText || "";
  if (fullText.length <= 280) {
    button.style.display = "none";
    body.innerHTML = formatAssistantText(fullText);
    return;
  }
  if (collapsed) {
    const preview = fullText.slice(0, 280) + "...";
    body.innerHTML = formatAssistantText(preview);
    button.textContent = "Show more";
    button.dataset.collapsed = "true";
  } else {
    body.innerHTML = formatAssistantText(fullText);
    button.textContent = "Show less";
    button.dataset.collapsed = "false";
  }
}

function getTrendEmoji(text) {
  const lower = text.toLowerCase();
  if (/(warning|risk|error|issue|alert)/.test(lower)) return "‚ö†Ô∏è";
  if (/(increase|up|growth|rise|improve)/.test(lower)) return "üìà";
  if (/(decrease|down|drop|decline|reduce)/.test(lower)) return "üìâ";
  return "";
}

function handleMessageAction(event, messageId, text) {
  const action = event.target?.dataset?.action;
  if (!action) return;
  if (action === "pin") {
    pinnedItems.unshift({ id: messageId, text });
    renderPinnedList();
  }
  if (action === "bookmark") {
    bookmarkedItems.unshift({ id: messageId, text });
    renderBookmarkList();
  }
  if (action === "copy") {
    navigator.clipboard.writeText(text);
  }
}

function renderPinnedList() {
  const list = document.getElementById("pinnedList");
  if (!list) return;
  list.innerHTML = pinnedItems.map(item => `
    <div class="chat-item" onclick="scrollToMessage('${item.id}')">
      ${escapeHtml(item.text.slice(0, 60))}${item.text.length > 60 ? "..." : ""}
    </div>
  `).join("");
}

function renderBookmarkList() {
  const list = document.getElementById("bookmarkList");
  if (!list) return;
  list.innerHTML = bookmarkedItems.map(item => `
    <div class="chat-item" onclick="scrollToMessage('${item.id}')">
      ${escapeHtml(item.text.slice(0, 60))}${item.text.length > 60 ? "..." : ""}
    </div>
  `).join("");
}

function scrollToMessage(messageId) {
  const el = document.querySelector(`[data-message-id="${messageId}"]`);
  if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
}

function enhanceStreamingMessage(row, bubble, text, messageId) {
  const meta = bubble.querySelector(".meta");
  const trendEmoji = getTrendEmoji(text);
  if (trendEmoji && meta) {
    const trend = document.createElement("span");
    trend.className = "trend";
    trend.textContent = trendEmoji;
    meta.appendChild(trend);
  }

  const body = bubble.querySelector(".text");
  const toggle = document.createElement("button");
  toggle.className = "details-toggle";
  toggle.dataset.fullText = text;
  toggle.dataset.collapsed = "true";
  toggle.addEventListener("click", () => {
    const collapsed = toggle.dataset.collapsed === "true";
    setDetailsState(toggle, body, !collapsed);
  });
  bubble.appendChild(toggle);
  setDetailsState(toggle, body, true);

  const actions = document.createElement("div");
  actions.className = "msg-actions";
  actions.innerHTML = `
    <button class="msg-action" data-action="pin">üìå Pin</button>
    <button class="msg-action" data-action="bookmark">‚≠ê Bookmark</button>
    <button class="msg-action" data-action="copy">Copy</button>
  `;
  actions.addEventListener("click", (e) => handleMessageAction(e, messageId, text));
  bubble.appendChild(actions);
}

function updateChatTags(chat, text) {
  const lower = text.toLowerCase();
  const tags = new Set(chat.tags || []);
  if (/(rating|score|review)/.test(lower)) tags.add("rating");
  if (/(mileage|miles|odometer)/.test(lower)) tags.add("mileage");
  if (/(finance|payment|invoice|budget|cost|price)/.test(lower)) tags.add("finance");
  chat.tags = Array.from(tags);
  renderChatList();
}

function updateSuggestions(text) {
  const suggestions = document.getElementById("suggestions");
  if (!suggestions) return;
  const base = [
    "Summarize the key takeaways.",
    "What should I do next?",
    "Call out any risks or warnings."
  ];
  if (/\d/.test(text)) {
    base.unshift("Explain the numbers in simple terms.");
  }
  suggestions.innerHTML = base.map(s => `
    <button class="suggestion-btn" data-suggestion="${escapeHtml(s)}">${escapeHtml(s)}</button>
  `).join("");
}


async function sendMessage() {
  if (isSending) return;

  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const messagesEl = document.getElementById("messages");
    const toneMode = document.getElementById("toneMode");

  const userText = input.value.trim();
  if (!userText) return;

  // ‚úÖ get chat FIRST
  let chat = chats.find(c => c.id === activeChatId);
  if (!chat) {



    createChat("New chat");
    chat = chats.find(c => c.id === activeChatId);
  }

  isSending = true;
  sendBtn.disabled = true;
  input.value = "";
  hasShownTyping = false;
  setKokoStatus("thinking", "Thinking");
  showTypingIndicator();

  // ‚úÖ show + save user msg
  chat.messages.push({ who: "You", text: userText });
  appendLine("You", userText);
  updateChatTags(chat, userText);

  // ‚úÖ rename chat title from first message
  if (chat.title === "New chat" || chat.title.startsWith("Chat ")) {
    chat.title = userText.slice(0, 24);
    renderChatList();
  }

  // ‚úÖ Koko streaming card
  const row = document.createElement("div");
  row.className = "msg koko";

  const av = document.createElement("img");
  av.className = "avatar";
  av.src = "{{ url_for('static', filename='Koala_Talking.png') }}";
  av.alt = "Koko";
  row.appendChild(av);

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = `
    <div class="meta">
      <span class="name">Koko</span>
      <span class="time">Just now</span>
    </div>
    <div class="text"><span class="stream"></span></div>
  `;
  row.appendChild(bubble);
  messagesEl.appendChild(row);

  const span = bubble.querySelector(".stream");
  let kokoFull = "";

  try {
    const response = await fetch("/chat_stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: userText,
        tone: toneMode ? toneMode.value : null
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split("\n\n");
      buffer = parts.pop();

      for (const part of parts) {
        if (!part.startsWith("data: ")) continue;
        const payload = JSON.parse(part.slice(6));

        if (payload.delta) {
            if (!hasShownTyping) {
            hideTypingIndicator();
            setKokoStatus("speaking", "Responding");
            hasShownTyping = true;
          }
          kokoFull += payload.delta;
          span.textContent += payload.delta;
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      }
    }

    chat.messages.push({ who: "Koko", text: kokoFull || "(no response)" });
    const finalText = kokoFull || "(no response)";
    const messageId = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
    row.dataset.messageId = messageId;
    span.innerHTML = formatAssistantText(finalText);
    enhanceStreamingMessage(row, bubble, finalText, messageId);

    chat.messages.push({ who: "Koko", text: finalText });
    updateChatTags(chat, finalText);
    updateSuggestions(finalText);

  } catch (err) {
    console.error(err);
    span.textContent = "Error: stream failed.";
    chat.messages.push({ who: "Koko", text: "Error: stream failed." });

  } finally {
    isSending = false;
    sendBtn.disabled = false;
    input.focus();
    hideTypingIndicator();
    setKokoStatus("listening", "Listening");
  }
}


async function uploadDocument(file) {
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  appendLine("You", `Uploaded document: ${file.name}`);

  try {
    const response = await fetch("/upload_doc", {
      method: "POST",
      body: formData
    });

    const payload = await response.json();
    if (!response.ok) {
      appendLine("Koko", payload.error || "Upload failed.");
      return;
    }

    appendLine("Koko", payload.message || "Document uploaded.");
  } catch (err) {
    console.error(err);
    appendLine("Koko", "Upload failed. Please try again.");
  }
}

  // Enter to send (Shift+Enter newline)
const inputEl = document.getElementById("input");

if (!window.__kokoKeyListenerAdded) {
  window.__kokoKeyListenerAdded = true;

  inputEl.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadInput = document.getElementById("docUpload");
  uploadBtn.addEventListener("click", () => uploadInput.click());
  uploadInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    uploadInput.value = "";
    uploadDocument(file);
  });

  document.getElementById("quickActions").addEventListener("click", (e) => {
    const action = e.target?.dataset?.action;
    if (!action) return;
    document.getElementById("input").value = action;
    sendMessage();
  });

  document.getElementById("suggestions").addEventListener("click", (e) => {
    const suggestion = e.target?.dataset?.suggestion;
    if (!suggestion) return;
    document.getElementById("input").value = suggestion;
    sendMessage();
  });

  const chatSearch = document.getElementById("chatSearch");
  chatSearch.addEventListener("input", () => renderChatList());

  document.getElementById("tagFilters").addEventListener("click", (e) => {
    const tag = e.target?.dataset?.tag;
    if (!tag) return;
    activeTagFilter = tag;
    document.querySelectorAll(".tag-filter").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tag === tag);
    });
    renderChatList();
  });

}

  // ‚úÖ THIS MUST BE OUTSIDE ANY OTHER LISTENER
  window.addEventListener("load", () => {
    if (!activeChatId) createChat("New chat");
  });
</script>
</body>
</html>